{% extends 'civilian/base.html' %}
{% block content %}

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

<nav class="breadcrumb">
    <a href="#">Home</a>
    <span>‚Ä∫</span>
    <span style="color: #0b1220; font-weight: 600;">Area Risk Heatmap - South Africa</span>
</nav>

<h2 class="header">Area Risk Heatmap - South Africa</h2>
<p class="muted">View reported issues across South African provinces and cities. Red zones indicate areas with multiple problems.</p>

<!-- Statistics Cards -->
<div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 24px;">
    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
        <div style="font-size: 24px; font-weight: 800; color: #1e40af;">{{ total_reports }}</div>
        <div style="font-size: 14px; color: #64748b; font-weight: 600;">Total Reports</div>
    </div>
    {% for category_key, category_data in reports_by_category.items %}
    <div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 16px;">
        <div style="font-size: 24px; font-weight: 800; color: #1e40af;">{{ category_data.count }}</div>
        <div style="font-size: 14px; color: #64748b; font-weight: 600;">{{ category_data.name }}</div>
    </div>
    {% endfor %}
</div>

<!-- Navigation Controls -->
<div style="background: #f0f9ff; border: 1px solid #0ea5e9; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
    <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 700; color: #0c4a6e;">üó∫Ô∏è Smart Navigation</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 16px;">
        <div>
            <label style="display: block; font-size: 13px; color: #4b5563; font-weight: 600; margin-bottom: 6px;">Current Location</label>
            <input id="currentLocation" type="text" placeholder="Auto-detected via GPS" readonly style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #f9fafb; color: #6b7280; outline: none;">
        </div>
        <div>
            <label style="display: block; font-size: 13px; color: #4b5563; font-weight: 600; margin-bottom: 6px;">Destination</label>
            <input id="destinationInput" type="text" placeholder="e.g., 5 Fortune Avenue Bedworth Park, or Cape Town" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #ffffff; color: #0b1220; outline: none;">
            <div style="font-size: 11px; color: #64748b; margin-top: 4px;">Enter any South African address or city name</div>
        </div>
        <div style="display: flex; align-items: end; gap: 8px;">
            <button id="startNavigation" style="background: #059669; color: #ffffff; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 600; cursor: pointer; flex: 1;">üöó Start Navigation</button>
            <button id="stopNavigation" style="background: #dc2626; color: #ffffff; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 600; cursor: pointer; flex: 1; display: none;">‚èπÔ∏è Stop Navigation</button>
        </div>
    </div>
    <div id="navigationStatus" style="margin-top: 12px; padding: 12px; background: #ecfdf5; border: 1px solid #a7f3d0; border-radius: 8px; display: none;">
        <div style="font-size: 14px; font-weight: 600; color: #065f46;">üìç Navigation Active</div>
        <div id="routeInfo" style="font-size: 12px; color: #047857; margin-top: 4px;"></div>
    </div>
</div>

<!-- Filters -->
<div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
    <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 700; color: #1e293b;">Filter Reports</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div>
            <label style="display: block; font-size: 13px; color: #4b5563; font-weight: 600; margin-bottom: 6px;">Area/Province</label>
            <select id="areaFilter" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #ffffff; color: #0b1220; outline: none;">
                <option value="">All Areas</option>
                <optgroup label="South African Provinces">
                    <option value="Western Cape">Western Cape</option>
                    <option value="Eastern Cape">Eastern Cape</option>
                    <option value="Northern Cape">Northern Cape</option>
                    <option value="Free State">Free State</option>
                    <option value="KwaZulu-Natal">KwaZulu-Natal</option>
                    <option value="North West">North West</option>
                    <option value="Gauteng">Gauteng</option>
                    <option value="Mpumalanga">Mpumalanga</option>
                    <option value="Limpopo">Limpopo</option>
                </optgroup>
                {% if areas %}
                <optgroup label="Reported Locations">
                    {% for area in areas %}
                    {% if area not in "Western Cape,Eastern Cape,Northern Cape,Free State,KwaZulu-Natal,North West,Gauteng,Mpumalanga,Limpopo" %}
                    <option value="{{ area }}">{{ area }}</option>
                    {% endif %}
                    {% endfor %}
                </optgroup>
                {% endif %}
            </select>
        </div>
        <div>
            <label style="display: block; font-size: 13px; color: #4b5563; font-weight: 600; margin-bottom: 6px;">Category</label>
            <select id="categoryFilter" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #ffffff; color: #0b1220; outline: none;">
                <option value="">All Categories</option>
                {% for category_key, category_name in categories %}
                <option value="{{ category_key }}">{{ category_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div>
            <label style="display: block; font-size: 13px; color: #4b5563; font-weight: 600; margin-bottom: 6px;">Severity</label>
            <select id="severityFilter" style="width: 100%; padding: 10px 12px; border-radius: 8px; border: 1px solid #d1d5db; background: #ffffff; color: #0b1220; outline: none;">
                <option value="">All Severities</option>
                {% for severity_key, severity_name in severities %}
                <option value="{{ severity_key }}">{{ severity_name }}</option>
                {% endfor %}
            </select>
        </div>
        <div style="display: flex; align-items: end;">
            <button id="clearFilters" style="background: #6b7280; color: #ffffff; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 600; cursor: pointer; margin-right: 8px;">Clear Filters</button>
            <button id="refreshMap" style="background: #1d4ed8; color: #ffffff; border: none; border-radius: 8px; padding: 10px 16px; font-weight: 600; cursor: pointer;">Refresh Map</button>
        </div>
    </div>
</div>

<!-- Map Container -->
<div style="background: #ffffff; border: 1px solid #e2e8f0; border-radius: 12px; overflow: hidden; margin-bottom: 24px;">
    <div id="map" style="height: 500px; width: 100%;"></div>
</div>

<!-- Legend -->
<div style="background: #f8fafc; border: 1px solid #e2e8f0; border-radius: 12px; padding: 20px; margin-bottom: 24px;">
    <h3 style="margin: 0 0 16px; font-size: 16px; font-weight: 700; color: #1e293b;">Map Legend</h3>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px;">
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 20px; height: 20px; background: #ef4444; border-radius: 50%; border: 2px solid #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
            <span style="font-size: 14px; color: #374151; font-weight: 600;">Critical Issues</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 20px; height: 20px; background: #f59e0b; border-radius: 50%; border: 2px solid #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
            <span style="font-size: 14px; color: #374151; font-weight: 600;">High Severity</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 20px; height: 20px; background: #eab308; border-radius: 50%; border: 2px solid #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
            <span style="font-size: 14px; color: #374151; font-weight: 600;">Medium Severity</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 20px; height: 20px; background: #22c55e; border-radius: 50%; border: 2px solid #ffffff; box-shadow: 0 2px 4px rgba(0,0,0,0.1);"></div>
            <span style="font-size: 14px; color: #374151; font-weight: 600;">Low Severity</span>
        </div>
        <div style="display: flex; align-items: center; gap: 8px;">
            <div style="width: 20px; height: 20px; background: #1d4ed8; border-radius: 50%; border: 3px solid #ffffff; box-shadow: 0 2px 8px rgba(0,0,0,0.3); animation: pulse 2s infinite;"></div>
            <span style="font-size: 14px; color: #374151; font-weight: 600;">Your Location</span>
        </div>
    </div>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
let map;
let markers = [];
let heatmapLayer;
let userLocationMarker = null;
let hazardAlerts = [];
let alertInterval = null;
let isAlertSystemActive = false;
let lastKnownLocation = null;
let voiceRecognition = null;
let isVoiceActive = false;
let speechSynthesis = window.speechSynthesis;
let alertedHazards = new Map();
let gpsStyleAlerts = true;
let currentRoute = null;
let destination = null;
let routeHazards = [];
let isNavigationMode = false;

// POTHOLE-ONLY CONFIGURATION
const ALERT_CATEGORY = 'Pothole';

// South African locations database (for quick reference and fallback)
const SA_LOCATIONS = {
    // Gauteng
    'johannesburg': { lat: -26.2041, lng: 28.0473, province: 'Gauteng' },
    'pretoria': { lat: -25.7479, lng: 28.2293, province: 'Gauteng' },
    'tshwane': { lat: -25.7479, lng: 28.2293, province: 'Gauteng' },
    'sandton': { lat: -26.1076, lng: 28.0567, province: 'Gauteng' },
    'soweto': { lat: -26.2678, lng: 27.8585, province: 'Gauteng' },
    'midrand': { lat: -25.9895, lng: 28.1289, province: 'Gauteng' },
    'centurion': { lat: -25.8601, lng: 28.1888, province: 'Gauteng' },
    'roodepoort': { lat: -26.1625, lng: 27.8725, province: 'Gauteng' },
    'benoni': { lat: -26.1885, lng: 28.3207, province: 'Gauteng' },
    'boksburg': { lat: -26.2121, lng: 28.2621, province: 'Gauteng' },
    'edenvale': { lat: -26.1336, lng: 28.1518, province: 'Gauteng' },
    'kempton park': { lat: -26.1016, lng: 28.2295, province: 'Gauteng' },
    
    // Western Cape
    'cape town': { lat: -33.9249, lng: 18.4241, province: 'Western Cape' },
    'stellenbosch': { lat: -33.9321, lng: 18.8602, province: 'Western Cape' },
    'paarl': { lat: -33.7340, lng: 18.9644, province: 'Western Cape' },
    'george': { lat: -33.9608, lng: 22.4617, province: 'Western Cape' },
    'worcester': { lat: -33.6453, lng: 19.4488, province: 'Western Cape' },
    'hermanus': { lat: -34.4187, lng: 19.2345, province: 'Western Cape' },
    'knysna': { lat: -34.0364, lng: 23.0471, province: 'Western Cape' },
    'mossel bay': { lat: -34.1817, lng: 22.1460, province: 'Western Cape' },
    
    // KwaZulu-Natal
    'durban': { lat: -29.8587, lng: 31.0218, province: 'KwaZulu-Natal' },
    'pietermaritzburg': { lat: -29.6007, lng: 30.3794, province: 'KwaZulu-Natal' },
    'richards bay': { lat: -28.7832, lng: 32.0378, province: 'KwaZulu-Natal' },
    'newcastle': { lat: -27.7574, lng: 29.9319, province: 'KwaZulu-Natal' },
    'ladysmith': { lat: -28.5592, lng: 29.7806, province: 'KwaZulu-Natal' },
    'ballito': { lat: -29.5392, lng: 31.2136, province: 'KwaZulu-Natal' },
    
    // Eastern Cape
    'port elizabeth': { lat: -33.9608, lng: 25.6022, province: 'Eastern Cape' },
    'gqeberha': { lat: -33.9608, lng: 25.6022, province: 'Eastern Cape' },
    'east london': { lat: -33.0153, lng: 27.9116, province: 'Eastern Cape' },
    'mthatha': { lat: -31.5895, lng: 28.7842, province: 'Eastern Cape' },
    'grahamstown': { lat: -33.3042, lng: 26.5328, province: 'Eastern Cape' },
    'uitenhage': { lat: -33.7577, lng: 25.3971, province: 'Eastern Cape' },
    
    // Free State
    'bloemfontein': { lat: -29.0852, lng: 26.1596, province: 'Free State' },
    'welkom': { lat: -27.9775, lng: 26.7397, province: 'Free State' },
    'bethlehem': { lat: -28.2307, lng: 28.3076, province: 'Free State' },
    'kroonstad': { lat: -27.6504, lng: 27.2340, province: 'Free State' },
    
    // Limpopo
    'polokwane': { lat: -23.9045, lng: 29.4689, province: 'Limpopo' },
    'tzaneen': { lat: -23.8333, lng: 30.1667, province: 'Limpopo' },
    'thohoyandou': { lat: -22.9481, lng: 30.4844, province: 'Limpopo' },
    'louis trichardt': { lat: -23.0439, lng: 29.9024, province: 'Limpopo' },
    
    // Mpumalanga
    'nelspruit': { lat: -25.4753, lng: 30.9703, province: 'Mpumalanga' },
    'mbombela': { lat: -25.4753, lng: 30.9703, province: 'Mpumalanga' },
    'witbank': { lat: -25.8733, lng: 29.2321, province: 'Mpumalanga' },
    'emalahleni': { lat: -25.8733, lng: 29.2321, province: 'Mpumalanga' },
    'secunda': { lat: -26.5504, lng: 29.1701, province: 'Mpumalanga' },
    
    // North West
    'rustenburg': { lat: -25.6672, lng: 27.2424, province: 'North West' },
    'mahikeng': { lat: -25.8647, lng: 25.6444, province: 'North West' },
    'klerksdorp': { lat: -26.8523, lng: 26.6670, province: 'North West' },
    'potchefstroom': { lat: -26.7140, lng: 27.1027, province: 'North West' },
    
    // Northern Cape
    'kimberley': { lat: -28.7282, lng: 24.7499, province: 'Northern Cape' },
    'upington': { lat: -28.4478, lng: 21.2561, province: 'Northern Cape' },
    'kuruman': { lat: -27.4572, lng: 23.4263, province: 'Northern Cape' }
};

// Geocode address using Nominatim (OpenStreetMap)
async function geocodeAddress(address) {
    try {
        // Add "South Africa" to ensure we're searching within SA
        const searchQuery = address.toLowerCase().includes('south africa') ? address : `${address}, South Africa`;
        
        const response = await fetch(
            `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(searchQuery)}&countrycodes=za&limit=1`,
            {
                headers: {
                    'User-Agent': 'SafetyReportApp/1.0'
                }
            }
        );
        
        if (!response.ok) {
            throw new Error('Geocoding service unavailable');
        }
        
        const data = await response.json();
        
        if (data && data.length > 0) {
            const result = data[0];
            return {
                lat: parseFloat(result.lat),
                lng: parseFloat(result.lon),
                displayName: result.display_name,
                province: extractProvince(result.display_name)
            };
        }
        
        return null;
    } catch (error) {
        console.error('Geocoding error:', error);
        return null;
    }
}

// Extract province from address
function extractProvince(displayName) {
    const provinces = [
        'Gauteng', 'Western Cape', 'Eastern Cape', 'KwaZulu-Natal',
        'Free State', 'Limpopo', 'Mpumalanga', 'North West', 'Northern Cape'
    ];
    
    for (const province of provinces) {
        if (displayName.includes(province)) {
            return province;
        }
    }
    
    return 'South Africa';
}

function findLocation(query) {
    const normalizedQuery = query.toLowerCase().trim();
    
    // Direct match in database
    if (SA_LOCATIONS[normalizedQuery]) {
        return SA_LOCATIONS[normalizedQuery];
    }
    
    // Partial match in database
    for (const [name, coords] of Object.entries(SA_LOCATIONS)) {
        if (name.includes(normalizedQuery) || normalizedQuery.includes(name)) {
            return coords;
        }
    }
    
    return null;
}

function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
              Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
              Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

// Initialize map
function initMap() {
    map = L.map('map').setView([-26.2041, 28.0473], 6);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);
    
    addLocationButton();
    addHazardAlertControls();
    loadMapData();
}

function loadMapData() {
    const areaFilter = document.getElementById('areaFilter').value;
    const categoryFilter = document.getElementById('categoryFilter').value;
    const severityFilter = document.getElementById('severityFilter').value;
    
    const params = new URLSearchParams();
    if (areaFilter) params.append('area', areaFilter);
    if (categoryFilter) params.append('category', categoryFilter);
    if (severityFilter) params.append('severity', severityFilter);
    params.append('format', 'json');
    
    clearMarkers();
    
    fetch(`?${params.toString()}`)
        .then(response => response.json())
        .then(data => {
            displayReports(data.reports);
            createHeatmap(data.reports);
        })
        .catch(error => {
            console.error('Error loading map data:', error);
        });
}

function addLocationButton() {
    const locationButton = L.control({position: 'topright'});
    
    locationButton.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'location-button');
        div.innerHTML = '<button id="locateUser" style="background: #1d4ed8; color: white; border: none; border-radius: 4px; padding: 8px 12px; cursor: pointer; font-size: 14px; font-weight: 600; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">üìç My Location</button>';
        
        L.DomEvent.on(div, 'click', function(e) {
            L.DomEvent.stopPropagation(e);
            locateUser();
        });
        
        return div;
    };
    
    locationButton.addTo(map);
}

function locateUser() {
    if (!navigator.geolocation) {
        alert('Geolocation is not supported by this browser.');
        return;
    }
    
    const button = document.getElementById('locateUser');
    const originalText = button.textContent;
    button.textContent = 'üìç Locating...';
    button.disabled = true;
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            
            if (lat < -22.0 || lat > -35.0 || lng < 16.0 || lng > 33.0) {
                if (!confirm('You appear to be outside South Africa. Would you like to center the map on your location anyway?')) {
                    button.textContent = originalText;
                    button.disabled = false;
                    return;
                }
            }
            
            if (userLocationMarker) {
                map.removeLayer(userLocationMarker);
            }
            
            userLocationMarker = L.marker([lat, lng], {
                icon: L.divIcon({
                    className: 'user-location-marker',
                    html: '<div style="background: #1d4ed8; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3); animation: pulse 2s infinite;"></div>',
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                })
            }).addTo(map);
            
            userLocationMarker.bindPopup(`
                <div style="text-align: center; font-family: system-ui, -apple-system, sans-serif;">
                    <h3 style="margin: 0 0 8px; font-size: 16px; font-weight: 700; color: #1e40af;">üìç Your Location</h3>
                    <p style="margin: 0; font-size: 14px; color: #64748b;">
                        Lat: ${lat.toFixed(6)}<br>
                        Lng: ${lng.toFixed(6)}
                    </p>
                </div>
            `);
            
            map.setView([lat, lng], 13);
            document.getElementById('currentLocation').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            lastKnownLocation = { lat, lng };
            
            button.textContent = originalText;
            button.disabled = false;
        },
        function(error) {
            let errorMessage = 'Unable to retrieve your location. ';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    errorMessage += 'Please allow location access and try again.';
                    break;
                case error.POSITION_UNAVAILABLE:
                    errorMessage += 'Location information is unavailable.';
                    break;
                case error.TIMEOUT:
                    errorMessage += 'Location request timed out.';
                    break;
                default:
                    errorMessage += 'An unknown error occurred.';
                    break;
            }
            alert(errorMessage);
            
            button.textContent = originalText;
            button.disabled = false;
        },
        {
            enableHighAccuracy: true,
            timeout: 10000,
            maximumAge: 60000
        }
    );
}

function clearMarkers() {
    markers.forEach(marker => map.removeLayer(marker));
    markers = [];
    
    if (heatmapLayer) {
        map.removeLayer(heatmapLayer);
        heatmapLayer = null;
    }
}

function addHazardAlertControls() {
    const alertControl = L.control({position: 'topleft'});
    
    alertControl.onAdd = function(map) {
        const div = L.DomUtil.create('div', 'hazard-alert-controls');
        div.innerHTML = `
            <div style="background: white; border-radius: 8px; padding: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); border: 1px solid #e2e8f0;">
                <h4 style="margin: 0 0 8px; font-size: 14px; font-weight: 700; color: #1e293b;">üöß Pothole Alerts</h4>
                <button id="toggleAlerts" style="background: #ef4444; color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 12px; font-weight: 600; width: 100%; margin-bottom: 8px;">Start Pothole Alerts</button>
                <button id="toggleVoice" style="background: #8b5cf6; color: white; border: none; border-radius: 6px; padding: 8px 12px; cursor: pointer; font-size: 12px; font-weight: 600; width: 100%; margin-bottom: 8px;">üé§ Voice Control</button>
                <div style="font-size: 11px; color: #64748b; text-align: center;">
                    <div id="alertStatus">Inactive</div>
                    <div id="alertCount" style="margin-top: 4px;">0 potholes nearby</div>
                    <div id="voiceStatus" style="margin-top: 4px; color: #8b5cf6;">Voice: Off</div>
                    <div id="gpsMode" style="margin-top: 4px; color: #c2410c; font-weight: 600;">Pothole-Only Mode</div>
                </div>
            </div>
        `;
        
        L.DomEvent.on(div, 'click', function(e) {
            L.DomEvent.stopPropagation(e);
            if (e.target.id === 'toggleAlerts') {
                toggleHazardAlerts();
            } else if (e.target.id === 'toggleVoice') {
                toggleVoiceControl();
            }
        });
        
        return div;
    };
    
    alertControl.addTo(map);
}

function toggleHazardAlerts() {
    const button = document.getElementById('toggleAlerts');
    const status = document.getElementById('alertStatus');
    
    if (isAlertSystemActive) {
        stopHazardAlerts();
        button.textContent = 'Start Pothole Alerts';
        button.style.background = '#ef4444';
        status.textContent = 'Inactive';
        status.style.color = '#64748b';
        if (isVoiceActive) {
            speak('Pothole alerts stopped');
        }
    } else {
        startHazardAlerts();
        button.textContent = 'Stop Pothole Alerts';
        button.style.background = '#22c55e';
        status.textContent = 'Active';
        status.style.color = '#22c55e';
        if (isVoiceActive) {
            speak('Pothole alerts started. You will be alerted at 600, 300, and 50 meters from potholes only');
        }
    }
}

function startHazardAlerts() {
    if (!navigator.geolocation) {
        alert('Geolocation is required for pothole alerts.');
        return;
    }
    
    isAlertSystemActive = true;
    
    navigator.geolocation.getCurrentPosition(
        function(position) {
            lastKnownLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };
            checkForHazards();
        },
        function(error) {
            alert('Unable to get location for pothole alerts: ' + error.message);
            stopHazardAlerts();
        },
        { enableHighAccuracy: true, timeout: 10000 }
    );
    
    alertInterval = setInterval(function() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
                function(position) {
                    lastKnownLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude
                    };
                    checkForHazards();
                },
                function(error) {
                    console.warn('Location update failed:', error.message);
                },
                { enableHighAccuracy: true, timeout: 5000, maximumAge: 30000 }
            );
        }
    }, 10000);
}

function stopHazardAlerts() {
    isAlertSystemActive = false;
    
    if (alertInterval) {
        clearInterval(alertInterval);
        alertInterval = null;
    }
    
    clearActiveAlerts();
}

function checkForHazards() {
    if (!lastKnownLocation) return;
    
    const simulatedHazards = simulateHazardData(lastKnownLocation);
    updateHazardAlerts(simulatedHazards);
}

function simulateHazardData(userLocation) {
    const hazards = [];
    const numPotholes = Math.floor(Math.random() * 5) + 3;
    
    for (let i = 0; i < numPotholes; i++) {
        const distance = Math.floor(Math.random() * 950) + 50;
        const angle = Math.random() * 2 * Math.PI;
        
        const latOffset = (distance / 111000) * Math.cos(angle);
        const lngOffset = (distance / (111000 * Math.cos(userLocation.lat * Math.PI / 180))) * Math.sin(angle);
        
        const severities = ['low', 'medium', 'high', 'critical'];
        const severity = severities[Math.floor(Math.random() * severities.length)];
        
        hazards.push({
            id: `pothole_${i}`,
            title: `Pothole on Road ${i + 1}`,
            category: 'Pothole',
            severity: severity,
            distance: distance,
            lat: userLocation.lat + latOffset,
            lng: userLocation.lng + lngOffset,
            location: `Approx ${distance}m from your location`,
            alert_level: distance <= 100 ? 'immediate' : distance <= 300 ? 'warning' : 'info'
        });
    }
    
    return hazards;
}

function updateHazardAlerts(hazards) {
    const potholes = hazards.filter(h => h.category === ALERT_CATEGORY);
    const alertCount = document.getElementById('alertCount');
    alertCount.textContent = `${potholes.length} potholes nearby`;
    
    if (gpsStyleAlerts && isAlertSystemActive) {
        potholes.forEach(pothole => {
            checkAndAlertHazard(pothole);
        });
    } else {
        const urgentPotholes = potholes.filter(p => 
            p.alert_level === 'immediate' || p.alert_level === 'warning'
        );
        
        urgentPotholes.forEach(pothole => {
            showHazardAlert(pothole);
        });
    }
}

function checkAndAlertHazard(hazard) {
    if (hazard.category !== ALERT_CATEGORY) {
        return;
    }
    
    const hazardKey = hazard.id;
    const distance = hazard.distance;
    
    const previousAlerts = alertedHazards.get(hazardKey) || [];
    const alertDistances = [600, 300, 50];
    
    alertDistances.forEach(alertDistance => {
        if (distance <= alertDistance && !previousAlerts.includes(alertDistance)) {
            previousAlerts.push(alertDistance);
            alertedHazards.set(hazardKey, previousAlerts);
            
            generateGPSAlert(hazard, alertDistance);
            
            if (alertDistance === 50) {
                showHazardAlert(hazard);
            }
        }
    });
    
    if (distance > 650) {
        alertedHazards.delete(hazardKey);
    }
}

function generateGPSAlert(hazard, distance) {
    let alertMessage = '';
    
    if (distance === 600) {
        alertMessage = `In 600 meters, there's a reported pothole near ${hazard.location}.`;
    } else if (distance === 300) {
        alertMessage = `In 300 meters, expect a pothole ahead.`;
    } else if (distance === 50) {
        alertMessage = `Pothole ahead ‚Äî slow down.`;
    }
    
    const priority = distance <= 50 ? 'urgent' : 'normal';
    speak(alertMessage, priority);
    
    console.log(`GPS Alert: ${hazard.title} at ${distance}m - ${alertMessage}`);
}

function showHazardAlert(hazard) {
    const alertKey = `hazard_${hazard.id}_${hazard.distance}`;
    if (sessionStorage.getItem(alertKey)) {
        return;
    }
    
    sessionStorage.setItem(alertKey, 'true');
    setTimeout(() => sessionStorage.removeItem(alertKey), 300000);
    
    const alertDiv = document.createElement('div');
    alertDiv.className = 'hazard-alert-notification';
    alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${getAlertColor(hazard.alert_level)};
        color: white;
        padding: 16px;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        z-index: 10000;
        max-width: 300px;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid ${getAlertBorderColor(hazard.alert_level)};
    `;
    
    alertDiv.innerHTML = `
        <div style="display: flex; align-items: center; margin-bottom: 8px;">
            <span style="font-size: 20px; margin-right: 8px;">${getAlertIcon(hazard.alert_level)}</span>
            <h4 style="margin: 0; font-size: 16px; font-weight: 700;">${getAlertTitle(hazard.alert_level)}</h4>
        </div>
        <p style="margin: 0 0 8px; font-size: 14px; line-height: 1.4;">üöß ${hazard.title}</p>
        <div style="font-size: 12px; opacity: 0.9;">
            <div><strong>Distance:</strong> ${hazard.distance}m away</div>
            <div><strong>Type:</strong> Pothole</div>
            <div><strong>Severity:</strong> ${hazard.severity}</div>
        </div>
        <button onclick="this.parentElement.remove()" style="position: absolute; top: 8px; right: 8px; background: none; border: none; color: white; font-size: 18px; cursor: pointer; opacity: 0.7;">√ó</button>
    `;
    
    document.body.appendChild(alertDiv);
    playAlertSound(hazard.alert_level);
    
    if (hazard.alert_level === 'immediate' || hazard.alert_level === 'warning') {
        const voiceMessage = `${hazard.alert_level === 'immediate' ? 'IMMEDIATE POTHOLE' : 'POTHOLE WARNING'}: ${hazard.title} at ${hazard.distance} meters.`;
        speak(voiceMessage, 'urgent');
    }
    
    setTimeout(() => {
        if (alertDiv.parentElement) {
            alertDiv.style.animation = 'slideOutRight 0.3s ease-in';
            setTimeout(() => alertDiv.remove(), 300);
        }
    }, 10000);
}

function getAlertColor(level) {
    switch (level) {
        case 'immediate': return '#dc2626';
        case 'warning': return '#ea580c';
        case 'info': return '#2563eb';
        default: return '#6b7280';
    }
}

function getAlertBorderColor(level) {
    switch (level) {
        case 'immediate': return '#991b1b';
        case 'warning': return '#c2410c';
        case 'info': return '#1d4ed8';
        default: return '#4b5563';
    }
}

function getAlertIcon(level) {
    switch (level) {
        case 'immediate': return 'üö®';
        case 'warning': return '‚ö†Ô∏è';
        case 'info': return '‚ÑπÔ∏è';
        default: return 'üìç';
    }
}

function getAlertTitle(level) {
    switch (level) {
        case 'immediate': return 'IMMEDIATE POTHOLE';
        case 'warning': return 'POTHOLE WARNING';
        case 'info': return 'Pothole Nearby';
        default: return 'Pothole Alert';
    }
}

function playAlertSound(level) {
    try {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        
        if (level === 'immediate') {
            playBeepPattern(audioContext, [200, 100, 200, 100, 200], 0.3);
        } else if (level === 'warning') {
            playBeepPattern(audioContext, [300, 200, 300], 0.2);
        }
    } catch (error) {
        console.log('Audio not available:', error);
    }
}

function playBeepPattern(audioContext, frequencies, duration) {
    frequencies.forEach((freq, index) => {
        setTimeout(() => {
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = freq;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + duration);
        }, index * (duration * 1000 + 50));
    });
}

function clearActiveAlerts() {
    const alerts = document.querySelectorAll('.hazard-alert-notification');
    alerts.forEach(alert => alert.remove());
}

function initVoiceRecognition() {
    if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
        console.warn('Speech recognition not supported');
        return false;
    }
    
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    voiceRecognition = new SpeechRecognition();
    
    voiceRecognition.continuous = true;
    voiceRecognition.interimResults = false;
    voiceRecognition.lang = 'en-US';
    voiceRecognition.maxAlternatives = 3;
    
    console.log('Voice recognition initialized with language:', voiceRecognition.lang);
    
    voiceRecognition.onstart = function() {
        console.log('Voice recognition started');
        speak('Voice control activated. Say "start alerts", "stop alerts", "start navigation", "navigate to city name", "status", or "help"');
    };
    
    voiceRecognition.onresult = function(event) {
        const result = event.results[event.results.length - 1];
        console.log('Voice recognition result:', result);
        
        let commandProcessed = false;
        
        for (let i = 0; i < result.length && !commandProcessed; i++) {
            const command = result[i].transcript.toLowerCase().trim();
            const confidence = result[i].confidence;
            
            console.log(`Alternative ${i + 1}: "${command}" (confidence: ${confidence})`);
            
            const wasRecognized = processVoiceCommand(command);
            
            if (wasRecognized) {
                commandProcessed = true;
                console.log(`Command recognized: "${command}"`);
            }
        }
        
        if (!commandProcessed) {
            console.log('No command alternatives were recognized');
            speak('Command not recognized. Try saying "start alerts", "stop alerts", "start navigation", "navigate to Durban", "status", or "help"');
        }
    };
    
    voiceRecognition.onerror = function(event) {
        console.error('Voice recognition error:', event.error);
        if (event.error === 'not-allowed') {
            speak('Microphone permission denied. Please allow microphone access for voice control.');
        }
    };
    
    voiceRecognition.onend = function() {
        if (isVoiceActive) {
            setTimeout(() => {
                if (isVoiceActive) {
                    voiceRecognition.start();
                }
            }, 100);
        }
    };
    
    return true;
}

function toggleVoiceControl() {
    const button = document.getElementById('toggleVoice');
    const status = document.getElementById('voiceStatus');
    
    if (isVoiceActive) {
        stopVoiceControl();
        button.textContent = 'üé§ Voice Control';
        button.style.background = '#8b5cf6';
        status.textContent = 'Voice: Off';
        status.style.color = '#8b5cf6';
    } else {
        if (initVoiceRecognition()) {
            startVoiceControl();
            button.textContent = 'üé§ Stop Voice';
            button.style.background = '#22c55e';
            status.textContent = 'Voice: On';
            status.style.color = '#22c55e';
        } else {
            speak('Voice recognition is not supported in your browser.');
        }
    }
}

function startVoiceControl() {
    isVoiceActive = true;
    if (voiceRecognition) {
        voiceRecognition.start();
    }
}

function stopVoiceControl() {
    isVoiceActive = false;
    if (voiceRecognition) {
        voiceRecognition.stop();
    }
}

function processVoiceCommand(command) {
    console.log('Processing command:', command);
    
    const normalizedCommand = command.toLowerCase()
        .replace(/[^\w\s]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    
    console.log('Normalized command:', normalizedCommand);
    
    const commands = {
        'start': ['start', 'begin', 'activate', 'turn on', 'enable'],
        'stop': ['stop', 'end', 'deactivate', 'turn off', 'disable'],
        'alerts': ['alert', 'alerts', 'gps', 'pothole', 'potholes'],
        'navigation': ['navigate', 'navigation', 'route', 'directions'],
        'status': ['status', 'check', 'how', 'what', 'info', 'report'],
        'location': ['location', 'where', 'position', 'coordinates'],
        'nearby': ['nearby', 'close', 'around', 'near'],
        'help': ['help', 'commands', 'what can i say'],
        'to': ['to', 'towards', 'destination']
    };
    
    const hasStart = commands.start.some(cmd => normalizedCommand.includes(cmd));
    const hasStop = commands.stop.some(cmd => normalizedCommand.includes(cmd));
    const hasAlerts = commands.alerts.some(cmd => normalizedCommand.includes(cmd));
    const hasNavigation = commands.navigation.some(cmd => normalizedCommand.includes(cmd));
    const hasStatus = commands.status.some(cmd => normalizedCommand.includes(cmd));
    const hasLocation = commands.location.some(cmd => normalizedCommand.includes(cmd));
    const hasNearby = commands.nearby.some(cmd => normalizedCommand.includes(cmd));
    const hasHelp = commands.help.some(cmd => normalizedCommand.includes(cmd));
    const hasTo = commands.to.some(cmd => normalizedCommand.includes(cmd));
    
    // Navigation commands
    if ((hasStart && hasNavigation) || normalizedCommand.includes('start navigation')) {
        if (!isNavigationMode) {
            const destInput = document.getElementById('destinationInput').value.trim();
            if (!destInput) {
                speak('Please enter a destination first or say "navigate to" followed by a city name');
                return true;
            }
            startNavigation();
        } else {
            speak('Navigation is already active');
        }
        return true;
    }
    
    if ((hasStop && hasNavigation) || normalizedCommand.includes('stop navigation')) {
        if (isNavigationMode) {
            stopNavigation();
            speak('Navigation stopped');
        } else {
            speak('Navigation is not active');
        }
        return true;
    }
    
    // "Navigate to [address/city]" command
    if (hasNavigation && hasTo) {
        const toIndex = normalizedCommand.indexOf('to');
        if (toIndex !== -1) {
            const destination = normalizedCommand.substring(toIndex + 2).trim();
            if (destination) {
                document.getElementById('destinationInput').value = destination;
                speak('Looking up destination...');
                
                // Use async processing
                processDestination(destination).then(destCoords => {
                    if (destCoords) {
                        startNavigation();
                    } else {
                        speak(`Sorry, I could not find ${destination}. Please try a different address or city.`);
                    }
                });
                return true;
            }
        }
    }
    
    // Check if command contains a city name from database
    for (const [cityName, coords] of Object.entries(SA_LOCATIONS)) {
        if (normalizedCommand.includes(cityName)) {
            if (hasNavigation || hasStart || normalizedCommand.includes('go to') || normalizedCommand.includes('drive to')) {
                document.getElementById('destinationInput').value = cityName;
                startNavigation();
                return true;
            }
        }
    }
    
    // Alerts commands
    if ((hasStart && hasAlerts) || normalizedCommand === 'start alerts') {
        if (!isAlertSystemActive) {
            toggleHazardAlerts();
            speak('Starting pothole alerts. You will be alerted at 600, 300, and 50 meters from potholes only');
        } else {
            speak('Pothole alerts are already active');
        }
        return true;
    }
    
    if ((hasStop && hasAlerts) || normalizedCommand === 'stop alerts') {
        if (isAlertSystemActive) {
            toggleHazardAlerts();
            speak('Stopping pothole alerts');
        } else {
            speak('Pothole alerts are already inactive');
        }
        return true;
    }
    
    if (hasStatus || normalizedCommand === 'status') {
        getStatusUpdate();
        return true;
    }
    
    if (hasLocation || normalizedCommand === 'location') {
        getLocationUpdate();
        return true;
    }
    
    if ((hasNearby && hasAlerts) || normalizedCommand === 'nearby potholes') {
        getNearbyHazards();
        return true;
    }
    
    if (hasHelp || normalizedCommand === 'help') {
        speak('Available commands: start alerts, stop alerts, start navigation, stop navigation, navigate to address or city name, status, location, nearby potholes. You can say "navigate to 5 Fortune Avenue Bedworth Park" or "go to Sandton". Note: alerts are for potholes only');
        return true;
    }
    
    if (normalizedCommand === 'start' || normalizedCommand === 'begin') {
        if (!isAlertSystemActive) {
            toggleHazardAlerts();
            speak('Starting pothole alerts');
        } else {
            speak('Pothole alerts are already active');
        }
        return true;
    }
    
    if (normalizedCommand === 'stop' || normalizedCommand === 'end') {
        if (isAlertSystemActive) {
            toggleHazardAlerts();
            speak('Stopping pothole alerts');
        } else {
            speak('Pothole alerts are already inactive');
        }
        return true;
    }
    
    console.log('No command matched for:', normalizedCommand);
    return false;
}

function speak(text, priority = 'normal') {
    if (!speechSynthesis) {
        console.warn('Speech synthesis not supported');
        return;
    }
    
    speechSynthesis.cancel();
    
    const utterance = new SpeechSynthesisUtterance(text);
    utterance.lang = 'en-US';
    utterance.rate = 0.9;
    utterance.pitch = 1.0;
    utterance.volume = priority === 'urgent' ? 1.0 : 0.8;
    
    const voices = speechSynthesis.getVoices();
    const saVoice = voices.find(voice => 
        voice.lang.includes('en-ZA') || 
        voice.lang.includes('en-GB') || 
        voice.name.includes('Google UK English')
    );
    
    if (saVoice) {
        utterance.voice = saVoice;
    }
    
    speechSynthesis.speak(utterance);
}

function getStatusUpdate() {
    const alertCount = document.getElementById('alertCount').textContent;
    const alertStatus = document.getElementById('alertStatus').textContent;
    
    let statusMessage = `Pothole alerts are ${alertStatus.toLowerCase()}. ${alertCount}`;
    
    if (isAlertSystemActive && lastKnownLocation) {
        statusMessage += '. GPS tracking is active. You will be alerted at 600, 300, and 50 meters from potholes only.';
    }
    
    if (isNavigationMode && currentRoute) {
        statusMessage += ` Navigation is active to ${currentRoute.destinationName}.`;
    }
    
    speak(statusMessage);
}

function getLocationUpdate() {
    if (lastKnownLocation) {
        speak(`Your current location is being tracked. GPS coordinates are ${lastKnownLocation.lat.toFixed(4)}, ${lastKnownLocation.lng.toFixed(4)}`);
    } else {
        speak('Location not available. Please enable location services.');
    }
}

function getNearbyHazards() {
    if (!isAlertSystemActive) {
        speak('Pothole alerts are not active. Say "start alerts" to begin monitoring.');
        return;
    }
    
    if (!lastKnownLocation) {
        speak('Location not available. Please enable location services.');
        return;
    }
    
    const simulatedHazards = simulateHazardData(lastKnownLocation);
    const potholes = simulatedHazards.filter(h => h.category === ALERT_CATEGORY);
    
    if (potholes && potholes.length > 0) {
        const immediatePotholes = potholes.filter(h => h.alert_level === 'immediate');
        const warningPotholes = potholes.filter(h => h.alert_level === 'warning');
        
        let message = `Found ${potholes.length} potholes nearby. `;
        
        if (immediatePotholes.length > 0) {
            message += `${immediatePotholes.length} immediate potholes within 100 meters. `;
            immediatePotholes.forEach(pothole => {
                message += `${pothole.title} at ${pothole.distance} meters. `;
            });
        }
        
        if (warningPotholes.length > 0) {
            message += `${warningPotholes.length} warning potholes within 300 meters. `;
        }
        
        speak(message, 'urgent');
    } else {
        speak('No potholes detected in your area. You are safe to proceed.');
    }
}

function displayReports(reports) {
    reports.forEach(report => {
        const marker = L.marker([report.lat, report.lng], {
            icon: getMarkerIcon(report.severity)
        }).addTo(map);
        
        const popupContent = `
            <div style="min-width: 250px; font-family: system-ui, -apple-system, sans-serif;">
                <h3 style="margin: 0 0 8px; font-size: 16px; font-weight: 700; color: #1e293b;">${report.title}</h3>
                <div style="margin-bottom: 8px;">
                    <span style="background: ${getSeverityColor(report.severity)}; color: white; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600;">${report.severity}</span>
                    <span style="background: #e2e8f0; color: #475569; padding: 2px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; margin-left: 4px;">${report.category}</span>
                </div>
                <p style="margin: 0 0 8px; font-size: 14px; color: #64748b; line-height: 1.4;">${report.description}</p>
                <div style="font-size: 12px; color: #94a3b8;">
                    <div><strong>Location:</strong> ${report.location}</div>
                    <div><strong>Reported:</strong> ${report.created_at}</div>
                    <div><strong>Status:</strong> ${report.status}</div>
                    ${report.has_image ? '<div>üì∑ Has Image</div>' : ''}
                    ${report.has_video ? '<div>üé• Has Video</div>' : ''}
                </div>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        markers.push(marker);
    });
}

function createHeatmap(reports) {
    if (reports.length === 0) return;
    
    const locationGroups = {};
    reports.forEach(report => {
        const key = `${report.lat.toFixed(4)},${report.lng.toFixed(4)}`;
        if (!locationGroups[key]) {
            locationGroups[key] = {
                lat: report.lat,
                lng: report.lng,
                count: 0,
                severity: report.severity
            };
        }
        locationGroups[key].count++;
    });
    
    const heatmapData = Object.values(locationGroups).map(location => ({
        lat: location.lat,
        lng: location.lng,
        intensity: Math.min(location.count / 5, 1)
    }));
    
    heatmapData.forEach(point => {
        const radius = Math.max(20, point.intensity * 100);
        const opacity = Math.max(0.3, point.intensity);
        
        const circle = L.circle([point.lat, point.lng], {
            radius: radius,
            fillColor: '#ef4444',
            color: '#dc2626',
            weight: 2,
            opacity: opacity,
            fillOpacity: opacity * 0.6
        }).addTo(map);
        
        markers.push(circle);
    });
}

function getMarkerIcon(severity) {
    const color = getSeverityColor(severity);
    return L.divIcon({
        className: 'custom-marker',
        html: `<div style="background: ${color}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 4px rgba(0,0,0,0.3);"></div>`,
        iconSize: [20, 20],
        iconAnchor: [10, 10]
    });
}

function getSeverityColor(severity) {
    switch (severity.toLowerCase()) {
        case 'critical': return '#ef4444';
        case 'high': return '#f59e0b';
        case 'medium': return '#eab308';
        case 'low': return '#22c55e';
        default: return '#6b7280';
    }
}

function startNavigation() {
    const destinationInput = document.getElementById('destinationInput');
    const destination = destinationInput.value.trim();
    
    if (!destination) {
        alert('Please enter a destination');
        speak('Please enter a destination');
        return;
    }
    
    if (!lastKnownLocation) {
        alert('Please enable location services first');
        speak('Please enable location services first');
        return;
    }
    
    // Show loading state
    const startButton = document.getElementById('startNavigation');
    const originalText = startButton.textContent;
    startButton.textContent = 'üîç Finding location...';
    startButton.disabled = true;
    
    // Try to find location
    processDestination(destination).then(destinationCoords => {
        if (!destinationCoords) {
            const message = `Unable to find "${destination}". Please check the address and try again.`;
            alert(message);
            speak(message);
            startButton.textContent = originalText;
            startButton.disabled = false;
            return;
        }
        
        isNavigationMode = true;
        
        document.getElementById('startNavigation').style.display = 'none';
        document.getElementById('stopNavigation').style.display = 'block';
        document.getElementById('navigationStatus').style.display = 'block';
        
        // Show full address in status
        const locationInfo = destinationCoords.displayName 
            ? destinationCoords.displayName.split(',').slice(0, 3).join(',')
            : destination;
        document.getElementById('routeInfo').textContent = `Navigating to: ${locationInfo}`;
        
        if (!isAlertSystemActive) {
            toggleHazardAlerts();
        }
        
        calculateRoute(lastKnownLocation, destinationCoords, destination);
        
        if (isVoiceActive) {
            speak(`Navigation started. Heading to ${destination} in ${destinationCoords.province}. Pothole alerts are active.`);
        } else {
            speak(`Navigation started to ${destination}`);
        }
        
        startButton.textContent = originalText;
        startButton.disabled = false;
    }).catch(error => {
        console.error('Navigation error:', error);
        alert('An error occurred while processing the destination. Please try again.');
        startButton.textContent = originalText;
        startButton.disabled = false;
    });
}

// Process destination: try database first, then geocoding
async function processDestination(destination) {
    // First, try the local database for quick city lookups
    const localResult = findLocation(destination);
    if (localResult) {
        return localResult;
    }
    
    // If not in database, use geocoding for street addresses
    speak('Looking up address...');
    const geocodedResult = await geocodeAddress(destination);
    
    if (geocodedResult) {
        return geocodedResult;
    }
    
    return null;
}

function stopNavigation() {
    isNavigationMode = false;
    
    if (map.routeLayer) {
        map.removeLayer(map.routeLayer);
        map.routeLayer = null;
    }
    if (map.routeStartMarker) {
        map.removeLayer(map.routeStartMarker);
        map.routeStartMarker = null;
    }
    if (map.routeEndMarker) {
        map.removeLayer(map.routeEndMarker);
        map.routeEndMarker = null;
    }
    
    currentRoute = null;
    routeHazards = [];
    
    document.getElementById('startNavigation').style.display = 'block';
    document.getElementById('stopNavigation').style.display = 'none';
    document.getElementById('navigationStatus').style.display = 'none';
    
    if (isVoiceActive) {
        speak('Navigation stopped');
    }
}

function calculateRoute(start, destinationCoords, destinationName) {
    console.log(`Calculating route from ${start.lat}, ${start.lng} to ${destinationName}`);
    
    const latDiff = destinationCoords.lat - start.lat;
    const lngDiff = destinationCoords.lng - start.lng;
    const numWaypoints = 5;
    
    const waypoints = [];
    for (let i = 1; i <= numWaypoints; i++) {
        waypoints.push({
            lat: start.lat + (latDiff * i / (numWaypoints + 1)),
            lng: start.lng + (lngDiff * i / (numWaypoints + 1))
        });
    }
    
    currentRoute = {
        start: start,
        destination: destinationCoords,
        destinationName: destinationName,
        waypoints: waypoints
    };
    
    drawRoute(currentRoute);
    checkRouteHazards();
    
    const distance = calculateDistance(start.lat, start.lng, destinationCoords.lat, destinationCoords.lng);
    speak(`Route calculated. Distance to ${destinationName} is approximately ${distance.toFixed(1)} kilometers`);
}

function drawRoute(route) {
    if (map.routeLayer) {
        map.removeLayer(map.routeLayer);
    }
    
    if (map.routeStartMarker) map.removeLayer(map.routeStartMarker);
    if (map.routeEndMarker) map.removeLayer(map.routeEndMarker);
    
    const routeCoords = [
        [route.start.lat, route.start.lng],
        ...route.waypoints.map(wp => [wp.lat, wp.lng]),
        [route.destination.lat, route.destination.lng]
    ];
    
    map.routeLayer = L.polyline(routeCoords, {
        color: '#059669',
        weight: 4,
        opacity: 0.8,
        dashArray: '10, 5'
    }).addTo(map);
    
    map.routeStartMarker = L.marker([route.start.lat, route.start.lng], {
        icon: L.divIcon({
            className: 'route-marker',
            html: '<div style="background: #059669; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">A</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        })
    }).addTo(map).bindPopup('<strong>Starting Point</strong>');
    
    map.routeEndMarker = L.marker([route.destination.lat, route.destination.lng], {
        icon: L.divIcon({
            className: 'route-marker',
            html: '<div style="background: #dc2626; color: white; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 16px; font-weight: bold; border: 3px solid white; box-shadow: 0 2px 8px rgba(0,0,0,0.3);">B</div>',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
        })
    }).addTo(map).bindPopup(`<strong>Destination:</strong> ${route.destinationName}`);
    
    map.fitBounds(map.routeLayer.getBounds(), { padding: [50, 50] });
}

function checkRouteHazards() {
    console.log('Checking for potholes along route...');
}

document.getElementById('areaFilter').addEventListener('change', loadMapData);
document.getElementById('categoryFilter').addEventListener('change', loadMapData);
document.getElementById('severityFilter').addEventListener('change', loadMapData);

document.getElementById('clearFilters').addEventListener('click', function() {
    document.getElementById('areaFilter').value = '';
    document.getElementById('categoryFilter').value = '';
    document.getElementById('severityFilter').value = '';
    loadMapData();
});

document.getElementById('refreshMap').addEventListener('click', loadMapData);

document.addEventListener('DOMContentLoaded', function() {
    initMap();
    
    document.getElementById('startNavigation').addEventListener('click', startNavigation);
    document.getElementById('stopNavigation').addEventListener('click', stopNavigation);
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            document.getElementById('currentLocation').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            lastKnownLocation = { lat, lng };
        });
    }
});

window.addEventListener('beforeunload', function() {
    if (isAlertSystemActive) {
        stopHazardAlerts();
    }
    if (isVoiceActive) {
        stopVoiceControl();
    }
    if (isNavigationMode) {
        stopNavigation();
    }
});

// Add this function to completely stop everything
function stopEverything() {
    console.log('Stopping all navigation and alerts...');
    
    // Stop navigation
    if (isNavigationMode) {
        stopNavigation();
    }
    
    // Stop hazard alerts
    if (isAlertSystemActive) {
        stopHazardAlerts();
    }
    
    // Stop voice control
    if (isVoiceActive) {
        stopVoiceControl();
    }
    
    // Clear any active alerts
    clearActiveAlerts();
    
    // Reset navigation UI
    document.getElementById('startNavigation').style.display = 'block';
    document.getElementById('stopNavigation').style.display = 'none';
    document.getElementById('navigationStatus').style.display = 'none';
    
    // Speak confirmation if voice was active
    if (isVoiceActive) {
        speak('All systems stopped. Navigation, alerts, and voice control have been turned off.');
    }
}

// Update the stopNavigation function to be more comprehensive
function stopNavigation() {
    console.log('Stopping navigation...');
    isNavigationMode = false;
    
    // Remove route from map
    if (map.routeLayer) {
        map.removeLayer(map.routeLayer);
        map.routeLayer = null;
    }
    if (map.routeStartMarker) {
        map.removeLayer(map.routeStartMarker);
        map.routeStartMarker = null;
    }
    if (map.routeEndMarker) {
        map.removeLayer(map.routeEndMarker);
        map.routeEndMarker = null;
    }
    
    // Reset navigation variables
    currentRoute = null;
    destination = null;
    routeHazards = [];
    
    // Update UI
    document.getElementById('startNavigation').style.display = 'block';
    document.getElementById('stopNavigation').style.display = 'none';
    document.getElementById('navigationStatus').style.display = 'none';
    document.getElementById('routeInfo').textContent = '';
    
    console.log('Navigation stopped completely');
}

// Update the processVoiceCommand function to handle "stop navigation" more comprehensively
function processVoiceCommand(command) {
    console.log('Processing command:', command);
    
    const normalizedCommand = command.toLowerCase()
        .replace(/[^\w\s]/g, '')
        .replace(/\s+/g, ' ')
        .trim();
    
    console.log('Normalized command:', normalizedCommand);
    
    // Handle "stop everything" or "stop all" commands
    if (normalizedCommand.includes('stop everything') || 
        normalizedCommand.includes('stop all') ||
        normalizedCommand.includes('stop all systems') ||
        normalizedCommand.includes('shut down everything')) {
        stopEverything();
        return true;
    }
    
    // Handle "stop navigation" command - stop everything related to navigation
    if (normalizedCommand.includes('stop navigation') || 
        normalizedCommand.includes('end navigation') ||
        normalizedCommand.includes('cancel navigation') ||
        normalizedCommand.includes('stop driving') ||
        normalizedCommand.includes('end route')) {
        
        if (isNavigationMode || isAlertSystemActive) {
            stopEverything();
            speak('Stopping all navigation systems, alerts, and voice control.');
        } else {
            speak('Navigation is not currently active.');
        }
        return true;
    }
    
    // Handle simple "stop" command - stop everything if navigation is active
    if (normalizedCommand === 'stop' && (isNavigationMode || isAlertSystemActive)) {
        stopEverything();
        speak('Stopping all systems.');
        return true;
    }
    
    // ... rest of your existing voice command processing code ...
    
    return false;
}

// Update the click event listener for stop navigation button
document.addEventListener('DOMContentLoaded', function() {
    initMap();
    
    document.getElementById('startNavigation').addEventListener('click', startNavigation);
    
    // Update stop navigation button to stop everything
    document.getElementById('stopNavigation').addEventListener('click', function() {
        if (isNavigationMode || isAlertSystemActive) {
            stopEverything();
            if (isVoiceActive) {
                speak('All systems stopped by button press.');
            }
        }
    });
    
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            document.getElementById('currentLocation').value = `${lat.toFixed(4)}, ${lng.toFixed(4)}`;
            lastKnownLocation = { lat, lng };
        });
    }
});

// Update the stopHazardAlerts function to be more thorough
function stopHazardAlerts() {
    console.log('Stopping hazard alerts...');
    isAlertSystemActive = false;
    
    if (alertInterval) {
        clearInterval(alertInterval);
        alertInterval = null;
    }
    
    // Clear all alerted hazards
    alertedHazards.clear();
    
    // Clear active alerts from UI
    clearActiveAlerts();
    
    // Update UI
    const button = document.getElementById('toggleAlerts');
    const status = document.getElementById('alertStatus');
    if (button && status) {
        button.textContent = 'Start Pothole Alerts';
        button.style.background = '#ef4444';
        status.textContent = 'Inactive';
        status.style.color = '#64748b';
    }
    
    console.log('Hazard alerts stopped');
}

// Update the stopVoiceControl function
function stopVoiceControl() {
    console.log('Stopping voice control...');
    isVoiceActive = false;
    if (voiceRecognition) {
        voiceRecognition.stop();
    }
    
    // Update UI
    const button = document.getElementById('toggleVoice');
    const status = document.getElementById('voiceStatus');
    if (button && status) {
        button.textContent = 'üé§ Voice Control';
        button.style.background = '#8b5cf6';
        status.textContent = 'Voice: Off';
        status.style.color = '#8b5cf6';
    }
    
    console.log('Voice control stopped');
}

// Add a function to handle page unload more gracefully
window.addEventListener('beforeunload', function() {
    if (isAlertSystemActive || isNavigationMode || isVoiceActive) {
        stopEverything();
    }
});

// Add keyboard shortcut for stopping everything (Escape key)
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape' && (isNavigationMode || isAlertSystemActive)) {
        stopEverything();
        // Show a brief notification
        const notification = document.createElement('div');
        notification.style.cssText = `
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #dc2626;
            color: white;
            padding: 16px 24px;
            border-radius: 8px;
            z-index: 10000;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        `;
        notification.textContent = 'All Systems Stopped';
        document.body.appendChild(notification);
        
        setTimeout(() => {
            if (notification.parentElement) {
                notification.remove();
            }
        }, 2000);
    }
});
</script>

<style>
.custom-marker {
    background: transparent !important;
    border: none !important;
}

@keyframes pulse {
    0% {
        transform: scale(1);
        opacity: 1;
    }
    50% {
        transform: scale(1.2);
        opacity: 0.7;
    }
    100% {
        transform: scale(1);
        opacity: 1;
    }
}

@keyframes slideInRight {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

@keyframes slideOutRight {
    from {
        transform: translateX(0);
        opacity: 1;
    }
    to {
        transform: translateX(100%);
        opacity: 0;
    }
}

.hazard-alert-controls button:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.hazard-alert-controls button:active {
    transform: translateY(0);
}

.user-location-marker {
    background: transparent !important;
    border: none !important;
}

.location-button button:hover {
    background: #1e40af !important;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.3) !important;
}

.location-button button:disabled {
    background: #9ca3af !important;
    cursor: not-allowed !important;
    transform: none !important;
}

@media (max-width: 768px) {
    .filters {
        grid-template-columns: 1fr !important;
    }
    
    #map {
        height: 400px !important;
    }
    
    .location-button button {
        font-size: 12px !important;
        padding: 6px 10px !important;
    }
}
</style>

{% endblock %}