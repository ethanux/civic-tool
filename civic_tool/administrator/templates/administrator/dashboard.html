{% extends 'administrator/base.html' %}
{% block content %}
<!-- Chart.js for analytics -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<nav class="breadcrumb">
    <a href="{% url 'admin_home' %}">Home</a>
    <span>â€º</span>
    <span style="color: #0b1220; font-weight: 600;">Dashboard</span>
</nav>

<h2 class="header">Administrator Dashboard</h2>
<p class="muted">Overview of system activities and metrics.</p>

<!-- Statistics Cards -->
<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin:20px 0;">
    <!-- Total Reports -->
    <div style="background:linear-gradient(135deg,#3b82f6,#1d4ed8);color:#ffffff;border-radius:12px;padding:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
                <div style="font-size:32px;font-weight:700;">{{ total_reports }}</div>
                <div style="font-size:14px;opacity:0.9;">Total Reports</div>
            </div>
            <div style="font-size:32px;">ðŸ“Š</div>
        </div>
    </div>

    <!-- Today's Reports -->
    <div style="background:linear-gradient(135deg,#10b981,#059669);color:#ffffff;border-radius:12px;padding:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
                <div style="font-size:32px;font-weight:700;">{{ today_reports }}</div>
                <div style="font-size:14px;opacity:0.9;">Today's Reports</div>
            </div>
            <div style="font-size:32px;">ðŸ“…</div>
        </div>
    </div>

    <!-- This Week's Reports -->
    <div style="background:linear-gradient(135deg,#f59e0b,#d97706);color:#ffffff;border-radius:12px;padding:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
                <div style="font-size:32px;font-weight:700;">{{ week_reports }}</div>
                <div style="font-size:14px;opacity:0.9;">This Week</div>
            </div>
            <div style="font-size:32px;">ðŸ“ˆ</div>
        </div>
    </div>

    <!-- Reports with Media -->
    <div style="background:linear-gradient(135deg,#8b5cf6,#7c3aed);color:#ffffff;border-radius:12px;padding:20px;box-shadow:0 4px 6px rgba(0,0,0,0.1);">
        <div style="display:flex;justify-content:space-between;align-items:center;">
            <div>
                <div style="font-size:32px;font-weight:700;">{{ reports_with_media }}</div>
                <div style="font-size:14px;opacity:0.9;">With Media</div>
            </div>
            <div style="font-size:32px;">ðŸ“·</div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0;">
    <!-- Daily Reports Chart -->
    <div style="background:#ffffff;border-radius:12px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin:0 0 15px 0;color:#1f2937;font-size:18px;">Reports by Day (Last 7 Days)</h3>
        <div style="position:relative;height:300px;width:100%;">
            <canvas id="dailyChart"></canvas>
        </div>
    </div>

    <!-- Status Distribution -->
    <div style="background:#ffffff;border-radius:12px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin:0 0 15px 0;color:#1f2937;font-size:18px;">Status Distribution</h3>
        <div style="position:relative;height:300px;width:100%;">
            <canvas id="statusChart"></canvas>
        </div>
    </div>
</div>

<!-- Analytics Sections -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0;">
    <!-- Category Breakdown -->
    <div style="background:#ffffff;border-radius:12px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin:0 0 15px 0;color:#1f2937;font-size:18px;">Category Breakdown</h3>
        {% for category, data in category_stats.items %}
        <div style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <span style="font-size:14px;color:#4b5563;">{{ data.name }}</span>
                <span style="font-size:14px;font-weight:600;color:#1f2937;">{{ data.count }} ({{ data.percentage }}%)</span>
            </div>
            <div style="background:#e5e7eb;border-radius:4px;height:8px;overflow:hidden;">
                <div style="background:linear-gradient(90deg,#3b82f6,#1d4ed8);height:100%;width:{{ data.percentage }}%;transition:width 0.3s ease;"></div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Status Breakdown -->
    <div style="background:#ffffff;border-radius:12px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin:0 0 15px 0;color:#1f2937;font-size:18px;">Status Breakdown</h3>
        {% for status, data in status_stats.items %}
        <div style="margin-bottom:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
                <span style="font-size:14px;color:#4b5563;">{{ data.name }}</span>
                <span style="font-size:14px;font-weight:600;color:#1f2937;">{{ data.count }} ({{ data.percentage }}%)</span>
            </div>
            <div style="background:#e5e7eb;border-radius:4px;height:8px;overflow:hidden;">
                {% if status == 'pending' %}
                <div style="background:linear-gradient(90deg,#f59e0b,#d97706);height:100%;width:{{ data.percentage }}%;transition:width 0.3s ease;"></div>
                {% elif status == 'in_progress' %}
                <div style="background:linear-gradient(90deg,#3b82f6,#1d4ed8);height:100%;width:{{ data.percentage }}%;transition:width 0.3s ease;"></div>
                {% elif status == 'resolved' %}
                <div style="background:linear-gradient(90deg,#10b981,#059669);height:100%;width:{{ data.percentage }}%;transition:width 0.3s ease;"></div>
                {% else %}
                <div style="background:linear-gradient(90deg,#6b7280,#4b5563);height:100%;width:{{ data.percentage }}%;transition:width 0.3s ease;"></div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
    </div>
</div>

<!-- Recent Activity and Top Reporters -->
<div style="display:grid;grid-template-columns:2fr 1fr;gap:20px;margin:20px 0;">
    <!-- Recent Reports -->
    <div style="background:#ffffff;border-radius:12px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin:0 0 15px 0;color:#1f2937;font-size:18px;">Recent Reports</h3>
        {% if recent_reports %}
        <div style="max-height:400px;overflow-y:auto;">
            {% for report in recent_reports %}
            <div style="border-bottom:1px solid #e5e7eb;padding:12px 0;{% if forloop.last %}border-bottom:none;{% endif %}">
                <div style="display:flex;justify-content:space-between;align-items:start;margin-bottom:4px;">
                    <h4 style="margin:0;font-size:14px;color:#1f2937;font-weight:600;">{{ report.title }}</h4>
                    <span style="font-size:12px;color:#6b7280;">{{ report.created_at|date:"M d, Y" }}</span>
                </div>
                <div style="display:flex;justify-content:space-between;align-items:center;">
                    <span style="font-size:12px;color:#4b5563;">{{ report.get_category_display }} â€¢ {{ report.location }}</span>
                    <span style="font-size:11px;padding:2px 8px;border-radius:12px;font-weight:500;
                        {% if report.status == 'pending' %}background:#fef3c7;color:#92400e;
                        {% elif report.status == 'in_progress' %}background:#dbeafe;color:#1e40af;
                        {% elif report.status == 'resolved' %}background:#d1fae5;color:#065f46;
                        {% else %}background:#f3f4f6;color:#374151;{% endif %}">
                        {{ report.get_status_display }}
                    </span>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color:#6b7280;text-align:center;margin:20px 0;">No reports found.</p>
        {% endif %}
    </div>

    <!-- Top Reporters -->
    <div style="background:#ffffff;border-radius:12px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1);">
        <h3 style="margin:0 0 15px 0;color:#1f2937;font-size:18px;">Top Reporters</h3>
        {% if top_reporters %}
        <div>
            {% for reporter in top_reporters %}
            <div style="display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid #e5e7eb;{% if forloop.last %}border-bottom:none;{% endif %}">
                <div>
                    <div style="font-size:14px;font-weight:500;color:#1f2937;">{{ reporter.username }}</div>
                    <div style="font-size:12px;color:#6b7280;">{{ reporter.email }}</div>
                </div>
                <span style="font-size:14px;font-weight:600;color:#3b82f6;">{{ reporter.report_count }}</span>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <p style="color:#6b7280;text-align:center;margin:20px 0;">No reporters found.</p>
        {% endif %}
    </div>
</div>

<!-- Quick Actions -->
<div style="background:#ffffff;border-radius:12px;padding:20px;box-shadow:0 2px 4px rgba(0,0,0,0.1);margin:20px 0;">
    <h3 style="margin:0 0 15px 0;color:#1f2937;font-size:18px;">Quick Actions</h3>
    <div style="display:flex;gap:12px;flex-wrap:wrap;">
        <a href="{% url 'admin_view_reported_issues' %}" style="background:#3b82f6;color:#ffffff;padding:10px 16px;border-radius:8px;text-decoration:none;font-size:14px;font-weight:500;">View All Reports</a>
        <a href="{% url 'admin_manage_reports' %}" style="background:#10b981;color:#ffffff;padding:10px 16px;border-radius:8px;text-decoration:none;font-size:14px;font-weight:500;">Manage Reports</a>
        <a href="{% url 'admin_manage_account' %}" style="background:#6b7280;color:#ffffff;padding:10px 16px;border-radius:8px;text-decoration:none;font-size:14px;font-weight:500;">Manage Account</a>
    </div>
</div>

<script>
// Daily Reports Chart
const dailyCtx = document.getElementById('dailyChart').getContext('2d');
const dailyChart = new Chart(dailyCtx, {
    type: 'line',
    data: {
        labels: [{% for day in daily_reports %}'{{ day.day }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            label: 'Reports',
            data: [{% for day in daily_reports %}{{ day.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            borderColor: '#3b82f6',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            borderWidth: 2,
            fill: true,
            tension: 0.4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
            intersect: false,
            mode: 'index'
        },
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                borderColor: '#3b82f6',
                borderWidth: 1
            }
        },
        scales: {
            x: {
                grid: {
                    display: false
                },
                ticks: {
                    color: '#6b7280'
                }
            },
            y: {
                beginAtZero: true,
                ticks: {
                    stepSize: 1,
                    color: '#6b7280'
                },
                grid: {
                    color: '#f3f4f6'
                }
            }
        },
        elements: {
            point: {
                radius: 4,
                hoverRadius: 6
            }
        }
    }
});

// Status Distribution Chart
const statusCtx = document.getElementById('statusChart').getContext('2d');
const statusChart = new Chart(statusCtx, {
    type: 'doughnut',
    data: {
        labels: [{% for status, data in status_stats.items %}'{{ data.name }}'{% if not forloop.last %},{% endif %}{% endfor %}],
        datasets: [{
            data: [{% for status, data in status_stats.items %}{{ data.count }}{% if not forloop.last %},{% endif %}{% endfor %}],
            backgroundColor: [
                '#f59e0b', // pending
                '#3b82f6', // in_progress
                '#10b981', // resolved
                '#6b7280'  // closed
            ],
            borderWidth: 0,
            hoverOffset: 4
        }]
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        cutout: '60%',
        plugins: {
            legend: {
                position: 'bottom',
                labels: {
                    padding: 20,
                    usePointStyle: true,
                    color: '#374151',
                    font: {
                        size: 12
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: '#fff',
                bodyColor: '#fff',
                callbacks: {
                    label: function(context) {
                        const total = context.dataset.data.reduce((a, b) => a + b, 0);
                        const percentage = ((context.parsed / total) * 100).toFixed(1);
                        return context.label + ': ' + context.parsed + ' (' + percentage + '%)';
                    }
                }
            }
        }
    }
});

// Resize charts when window is resized
window.addEventListener('resize', function() {
    dailyChart.resize();
    statusChart.resize();
});
</script>
{% endblock %}



